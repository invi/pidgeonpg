<!DOCTYPE html><html lang="en"><head><title>ppgapp</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="ppgapp"><meta name="groc-project-path" content="lib/ppgapp.js"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path">lib/ppgapp.js</div></div><div id="document"><div class="segment"><div class="comments"><div class="wrapper"><h1 id="ppgapp">ppgapp</h1>

<pre><code>Stability: 2 - Unstable
</code></pre>

<p>Direct OpenPGP protocol operations and application using a predefined
local key ring. To use this module use <code>require('ppgapp')</code>. Methods
have asynchronous or synchronous forms.</p>

<p>The asynchronous form always take a completion callback as its last argument.
The arguments passed to the completion callback depend on the method, but the
first argument is always reserved for an exception. If the operation was
completed successfully, then the first argument will be <code>null</code> or <code>undefined</code>.</p>

<p>When using the synchronous form any exceptions are immediately thrown.
You can use try/catch to handle exceptions or allow them to bubble up.</p>

<p>Here is an example of the asynchronous version:</p>

<pre><code>var ppgapp = require('ppgapp');

ppgapp.sign("Signed message with key", "B5E4BE82180EE2D9", function(err, enc) {
  if (err) throw err;
  console.log('following is showing encrypted message');
  console.log(enc);
}
</code></pre>

<p>Here is a synchronous version:</p>

<pre><code>var ppgapp = require('ppgapp');

ppgapp.find_key("0xB5E4BE82180EE2D9");
</code></pre>

<p>The tests for this module can be found <a href="test/test-ppgappapp.html">here</a>.</p></div></div><div class="code"><div class="wrapper"><span class="kr">const</span> <span class="nx">PGP</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;pgp/openpgpdefs.js&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">logger</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util/logger&#39;</span><span class="p">).</span><span class="nx">create</span><span class="p">(</span><span class="s2">&quot;ppgapp.js&quot;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">storage</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;ring/storage&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">armor</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;encode/armor&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">misc</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util/misc&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="p">{</span><span class="nx">Key</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;pgp/key&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="p">{</span><span class="nx">Subkey</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;pgp/subkey&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="p">{</span><span class="nx">EncryptedMessage</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;pgp/encryptedmessage&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="p">{</span><span class="nx">ClearSignMessage</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;pgp/clearsignmessage&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="p">{</span><span class="nx">Message</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;pgp/message&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="p">{</span><span class="nx">parsekeys</span><span class="p">,</span> <span class="nx">parsekeysfile</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;pgp/key-parse&quot;</span><span class="p">);</span>
<span class="kr">const</span> <span class="p">{</span><span class="nx">setLang</span><span class="p">,</span> <span class="nx">getStr</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util/lang&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="object-ppgapp">Object ppgapp</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="kd">var</span> <span class="nx">ppgapp</span> <span class="o">=</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="importdatadata-callback">importData(data, callback)</h3>

<p><code>data</code> binary or armored key block data as <code>string</code> </p>

<p><code>callback</code> get two arguments <code>(err, keys)</code> where <code>keys</code> is an array 
of the merged keys into the key ring</p></div></div><div class="code"><div class="wrapper">  <span class="nx">importData</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">filedata</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="nx">parsekeys</span><span class="p">(</span><span class="nx">filedata</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">imported_keys</span> <span class="o">=</span> <span class="p">[</span> <span class="p">];</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> 
      <span class="nx">storage</span><span class="p">.</span><span class="nx">importKey</span><span class="p">(</span><span class="nx">keys</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">merged_key</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="nx">imported_keys</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">merged_key</span><span class="p">.</span><span class="nx">getFormatted</span><span class="p">());</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">merged_key</span><span class="p">.</span><span class="nx">getFormatted</span><span class="p">());</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">imported_keys</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> 
          <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
      <span class="p">});</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="importfilefilename-callback">importFile(filename, [callback])</h3>

<p><code>filename</code> is a <code>string</code> containing key filename.</p>

<p><code>callback</code> first' argument is the merged key into the local key ring</p></div></div><div class="code"><div class="wrapper">  <span class="nx">importFile</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">filename</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="nx">parsekeysfile</span><span class="p">(</span><span class="nx">filename</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">imported_keys</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> 
      <span class="nx">storage</span><span class="p">.</span><span class="nx">importKey</span><span class="p">(</span><span class="nx">keys</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">merged_key</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="k">return</span><span class="p">;</span> <span class="p">};</span>
        <span class="nx">imported_keys</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">merged_key</span><span class="p">.</span><span class="nx">getFormatted</span><span class="p">());</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">imported_keys</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> 
          <span class="nx">callback</span><span class="p">(</span><span class="nx">imported_keys</span><span class="p">);</span>
      <span class="p">});</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="generatekeypairoptions-callback">generateKeypair(options, [callback])</h3>

<p>Asynchronous key pair generation. </p>

<p>The first argument, the <code>options</code> should be an object
containing several members. </p>

<p>Example:</p>

<pre><code>var options = { 
  expireseconds: 0,
  name: "test name &lt;test@ppgapp.org&gt; (test comment)",
  keyType: PGP.PUBKEY.ALGO.RSA,
  keypairBits: 2048,
  subkeyType: PGP.PUBKEY.ALGO.RSA,
  subkeypairBits: 2048,
}
</code></pre></div></div><div class="code"><div class="wrapper">  <span class="nx">generateKeypair</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">Key</span><span class="p">.</span><span class="nx">generate</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">storage</span><span class="p">.</span><span class="nx">importKey</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">imported_key</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
          <span class="k">else</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">imported_key</span><span class="p">.</span><span class="nx">getFormatted</span><span class="p">());</span> 
        <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">},</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="revokekeykeyid-reason-comment-callback">revokeKey(keyid, reason, comment, callback)</h3>

<p><code>reason</code> revocation reason value as <code>integer</code></p>

<p><code>comment</code> optional revocation comment as <code>string</code>. May be empty string.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">revokeKey</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">RevokeKey</span><span class="p">(</span><span class="nx">keyid</span><span class="p">,</span> <span class="nx">reason</span><span class="p">,</span> <span class="nx">comment</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">fetchKey</span><span class="p">(</span><span class="nx">keyid</span><span class="p">);</span>
      <span class="nx">key</span><span class="p">.</span><span class="nx">generateRevocation</span><span class="p">(</span><span class="nx">reason</span><span class="p">,</span> <span class="nx">comment</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> 
          <span class="k">else</span> <span class="p">{</span>
            <span class="nx">storage</span><span class="p">.</span><span class="nx">update_key</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
            <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">}</span>
  <span class="p">},</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="revokesubkeykeyid-reason-comment-callback">revokeSubkey(keyid, reason, comment, callback)</h3>

<p><code>reason</code> revocation reason value as <code>integer</code></p>

<p><code>comment</code> optional revocation comment as <code>string</code>. May be empty string.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">revokeSubkey</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">RevokeSubkey</span><span class="p">(</span><span class="nx">keyid</span><span class="p">,</span> <span class="nx">reason</span><span class="p">,</span> <span class="nx">comment</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">fetchKey</span><span class="p">(</span><span class="nx">keyid</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">subkey</span> <span class="o">=</span> <span class="nx">key</span><span class="p">.</span><span class="nx">getKey</span><span class="p">(</span><span class="nx">misc</span><span class="p">.</span><span class="nx">atos</span><span class="p">(</span><span class="nx">misc</span><span class="p">.</span><span class="nx">hextoa</span><span class="p">(</span><span class="nx">keyid</span><span class="p">)));</span>
    <span class="nx">subkey</span><span class="p">.</span><span class="nx">generateRevocation</span><span class="p">(</span><span class="nx">reason</span><span class="p">,</span> <span class="nx">comment</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">updated_key</span> <span class="o">=</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">update_key</span><span class="p">(</span><span class="nx">subkey</span><span class="p">.</span><span class="nx">key</span><span class="p">);</span>
      <span class="nx">callback</span><span class="p">(</span><span class="nx">updated_key</span><span class="p">.</span><span class="nx">getFormatted</span><span class="p">(),</span> <span class="nx">subkey</span><span class="p">.</span><span class="nx">getFormatted</span><span class="p">());</span>
    <span class="p">});</span>
  <span class="p">},</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="revokeuseridkeyid-uid-index-reason-comment-callback">revokeUserId(keyid, uid_index, reason, comment, [callback])</h3>

<p><code>uid\_index</code> revocation reason value as <code>integer</code></p>

<p><code>reason</code> revocation reason value as <code>integer</code></p>

<p><code>comment</code> optional revocation comment as <code>string</code>. May be empty string.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">revokeUserId</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">RevokeUserId</span><span class="p">(</span><span class="nx">keyid</span><span class="p">,</span> <span class="nx">uid_index</span><span class="p">,</span> <span class="nx">reason</span><span class="p">,</span> <span class="nx">comment</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">keyid</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">key</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Key not found&quot;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">uid</span> <span class="o">=</span> <span class="nx">key</span><span class="p">.</span><span class="nx">uids</span><span class="p">[</span><span class="nx">uid_index</span><span class="p">];</span>
    <span class="nx">uid</span><span class="p">.</span><span class="nx">generateRevocation</span><span class="p">(</span><span class="nx">reason</span><span class="p">,</span> <span class="nx">comment</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">updated_key</span> <span class="o">=</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">update_key</span><span class="p">(</span><span class="nx">uid</span><span class="p">.</span><span class="nx">key</span><span class="p">);</span>
      <span class="nx">callback</span><span class="p">(</span><span class="nx">updated_key</span><span class="p">.</span><span class="nx">getFormatted</span><span class="p">(),</span> <span class="nx">uid</span><span class="p">.</span><span class="nx">getFormatted</span><span class="p">());</span>
    <span class="p">});</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="generateuseridkeyid-options-callback">generateUserId(keyid, options, [callback])</h3>

<p><code>options</code> example:</p>

<pre><code> var options =  { name : "uid full name", expireseconds: 0 };
</code></pre></div></div><div class="code"><div class="wrapper">  <span class="nx">generateUserId</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">keyid</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">fetchKey</span><span class="p">(</span><span class="nx">keyid</span><span class="p">);</span>
      <span class="nx">key</span><span class="p">.</span><span class="nx">generateUserId</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">expireseconds</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">uid</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">updated_key</span> <span class="o">=</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">update_key</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
          <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">updated_key</span><span class="p">.</span><span class="nx">getFormatted</span><span class="p">(),</span> <span class="nx">uid</span><span class="p">.</span><span class="nx">getFormatted</span><span class="p">());</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="generatesubkeykeyid-options-callback">generateSubkey(keyid, options, [callback])</h3>

<pre><code>var options = { subkeyType: PGP.PUBKEY.RSA,
                keypairBits: 2048
                expireseconds: 0 }
</code></pre></div></div><div class="code"><div class="wrapper">  <span class="nx">generateSubkey</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">keyid</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">keyid</span><span class="p">);</span>
      <span class="kd">var</span> <span class="p">{</span><span class="nx">subkeyType</span><span class="p">,</span> <span class="nx">keypairBits</span><span class="p">,</span> <span class="nx">expireseconds</span><span class="p">}</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span>
      <span class="nx">Subkey</span><span class="p">.</span><span class="nx">generate</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">subkeyType</span><span class="p">,</span> <span class="nx">keypairBits</span><span class="p">,</span> <span class="nx">expireseconds</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">subkey</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
          <span class="k">else</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">updated_key</span> <span class="o">=</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">update_key</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
            <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">updated_key</span><span class="p">.</span><span class="nx">getFormatted</span><span class="p">(),</span> <span class="nx">subkey</span><span class="p">.</span><span class="nx">getFormatted</span><span class="p">());</span>
          <span class="p">}</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="signuseridkeyid-uid-index-callback">signUserId(keyid, uid_index, callback)</h3>

<p>Generate User Id signature for the given index</p></div></div><div class="code"><div class="wrapper">  <span class="nx">signUserId</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">keyid</span><span class="p">,</span> <span class="nx">uid_index</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">defaultkey</span> <span class="o">=</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">fetchDefaultKey</span><span class="p">();</span>
      <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">fetchKey</span><span class="p">(</span><span class="nx">keyid</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">uid</span> <span class="o">=</span> <span class="nx">key</span><span class="p">.</span><span class="nx">uids</span><span class="p">[</span><span class="nx">uid_index</span><span class="p">];</span>
      <span class="nx">uid</span><span class="p">.</span><span class="nx">signUserId</span><span class="p">(</span><span class="nx">defaultkey</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> 
        <span class="k">else</span> <span class="p">{</span>
          <span class="nx">storage</span><span class="p">.</span><span class="nx">update_key</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
          <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
  <span class="p">},</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="signmsgdata-keyid-callback">sign(msgdata, keyid, [callback])</h3>

<p>Creates an armored cleartext signatures for given string</p></div></div><div class="code"><div class="wrapper">  <span class="nx">sign</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">Sign</span><span class="p">(</span><span class="nx">msgdata</span><span class="p">,</span> <span class="nx">keyid</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">func</span><span class="p">(</span><span class="s2">&quot;sign&quot;</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">msg</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Message</span><span class="p">(</span><span class="nx">msgdata</span><span class="p">);</span>
      <span class="nx">msg</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">keyid</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">msg</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="encryptmsgdata-ekeyid-skeyid-callback">encrypt(msgdata, ekeyid, skeyid, callback)</h3>

<p>Creates an armored encrypted message </p></div></div><div class="code"><div class="wrapper">  <span class="nx">encrypt</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msgdata</span><span class="p">,</span> <span class="nx">ekeyids</span><span class="p">,</span> <span class="nx">skeyids</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">msg</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Message</span><span class="p">(</span><span class="nx">msgdata</span><span class="p">);</span>
      <span class="nx">msg</span><span class="p">.</span><span class="nx">encrypt</span><span class="p">(</span><span class="nx">ekeyids</span><span class="p">,</span> <span class="nx">skeyids</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="k">else</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">msg</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="decryptmsgdata-callback">decrypt(msgdata, callback)</h3>

<p>Decrypts the given armored or binary  encrypted message</p>

<p><code>msgdata</code> Encrypted message data as string</p>

<p><code>callback</code> (err, encmsg) The second argument of the callback
return the armored encrypted message</p></div></div><div class="code"><div class="wrapper">  <span class="nx">decrypt</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msgdata</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">emsg</span> <span class="o">=</span> <span class="nx">EncryptedMessage</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">msgdata</span><span class="p">);</span>
      <span class="nx">emsg</span><span class="p">.</span><span class="nx">decrypt</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">msg</span><span class="p">,</span> <span class="nx">emsg</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">getKeyIdStr</span><span class="p">());</span>
      <span class="p">});</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="verifymsgdata-callback">verify(msgdata, [callback])</h3>

<p><code>msgdata</code> Message data as <code>string</code></p>

<p><code>callback</code> (err, data)</p></div></div><div class="code"><div class="wrapper">  <span class="nx">verify</span> <span class="o">:</span> <span class="kd">function</span> <span class="nx">Verify</span><span class="p">(</span><span class="nx">msgdata</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">func</span><span class="p">(</span><span class="s2">&quot;verify&quot;</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">smsg</span> <span class="o">=</span> <span class="nx">ClearSignMessage</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">msgdata</span><span class="p">);</span>
      <span class="nx">smsg</span><span class="p">.</span><span class="nx">verify</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">valid</span><span class="p">,</span> <span class="nx">issuerkeyid</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">issuerkeyid</span><span class="p">)</span>
        <span class="k">else</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">valid</span><span class="p">,</span> <span class="nx">issuerkeyid</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
  <span class="p">},</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="removekeykeyid">removeKey(keyid)</h3>

<p>Removes the given key from the local key ring</p>

<p><code>keyidstr</code> keyidstr Key ID in hexadecimal long format</p>

<p>Returns <code>null</code> if success, otherwise an error is thrown</p></div></div><div class="code"><div class="wrapper">  <span class="nx">removeKey</span><span class="o">:</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">removeKey</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="removeuseridkeyid-uid-index">removeUserId(keyid, uid_index)</h3>

<p>Removes the given User ID key from the local key ring</p>

<p><code>keyid</code> Key ID in hexadecimal long format
<code>uid_index</code> UserId index to remove</p>

<p>Returns <code>null</code> if success, otherwise an error is thrown</p></div></div><div class="code"><div class="wrapper">  <span class="nx">removeUserId</span><span class="o">:</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">removeUserId</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="removesubkeykeyid">removeSubKey(keyid)</h3>

<p>Removes subkey from local key ring</p>

<p><code>keyid</code> Key ID in hexadecimal long format</p>

<p>Return the found key, false otherwise</p></div></div><div class="code"><div class="wrapper">  <span class="nx">removeSubkey</span><span class="o">:</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">removeSubkey</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="findkeykeyid">findKey(keyid)</h3>

<p><code>keyid</code> Key ID in hexadecimal long format</p>

<p>Returns the found key, false otherwise</p></div></div><div class="code"><div class="wrapper">  <span class="nx">findKey</span><span class="o">:</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">findKey</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="exportpublickeyids">exportPublic(keyids)</h3>

<p><code>keyids</code> array of Key IDs in hexadecimal long format</p>

<p>Return the exported keys as string, false otherwise</p></div></div><div class="code"><div class="wrapper">  <span class="nx">exportPublic</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">ExportPubKey</span><span class="p">(</span><span class="nx">keyids</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">bin_keys</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">keyids</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">keyids</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
      <span class="nx">bin_keys</span> <span class="o">+=</span> <span class="nx">key</span><span class="p">.</span><span class="nx">export_pubkey</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">armor</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span><span class="nx">bin_keys</span><span class="p">,</span> <span class="nx">PGP</span><span class="p">.</span><span class="nx">ARMOR</span><span class="p">.</span><span class="nx">PUBLICKEY</span><span class="p">);</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="exportsecretkeyid">exportSecret(keyid)</h3>

<p><code>keyid</code> Key ID in hexadecimal long format</p>

<p>Return the exported secret key as string, false otherwise</p></div></div><div class="code"><div class="wrapper">  <span class="nx">exportSecret</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">ExportSecKey</span><span class="p">(</span><span class="nx">keyid</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">keyid</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">key</span><span class="p">.</span><span class="nx">export_seckey</span><span class="p">();</span>
  <span class="p">},</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="getpublickeys">getPublicKeys()</h3>

<p>Retreives all public keys from local key ring</p></div></div><div class="code"><div class="wrapper">  <span class="nx">getPublicKeys</span> <span class="o">:</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">getPublicKeys</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="getallkeys">getAllKeys()</h3>

<p>Retreives all keys from local key ring</p></div></div><div class="code"><div class="wrapper">  <span class="nx">getAllKeys</span> <span class="o">:</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">getAllKeys</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="getdefaultkeyid">getDefaultKeyId()</h3>

<p>Return the default keyid</p></div></div><div class="code"><div class="wrapper">  <span class="nx">getDefaultKeyId</span> <span class="o">:</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">getDefaultKeyId</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="setdefaultkeyidkeyid">setDefaultKeyId(keyid)</h3>

<p><code>keyid</code> to set as default</p></div></div><div class="code"><div class="wrapper">  <span class="nx">setDefaultKeyId</span> <span class="o">:</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">setDefaultKeyId</span><span class="p">,</span>
<span class="p">}</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">ppgapp</span> <span class="o">=</span> <span class="nx">ppgapp</span><span class="p">;</span></div></div></div></div></body></html>